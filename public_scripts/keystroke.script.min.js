console.log('Keystroke Analytics Script Starting...');var allDOMS=document.getElementsByTagName('*');var keydownDOMObserver=Rx.DOM.keydown(allDOMS);var KEYSTROKE_CODE_COLLECT_LIMIT_BACKUP;var KEYSTROKE_CODE_COLLECT_LIMIT;var keystroke_dt=[];var keystroke_code=[[]];var t1=-1;var t2;var myheaders={'Content-Type':'application/x-www-form-urlencoded'};let tmp=document.getElementById('contAuthServerScriptTag').src.split('/');var cont_auth_server_url=tmp[0]+'//'+tmp[2];var cont_auth_server_get_keystroke_code_limit=cont_auth_server_url+'/collect/'+'get_keystroke_code_collect_limit/'+track_code
var cont_auth_server_collect_url=cont_auth_server_url+'/collect/'+'keystrokes';var cont_auth_server_get_random_sentence=cont_auth_server_url+'/misc/'+'get-random-sentence';var RANDOM_SENTENCE_RETAKE_MAXIMUM_LENGTH=40;var KEYSTROKE_CODE_COLLECT_LIMIT_RETAKE_OFFSET=5;const STORAGE_GET_ITEM_FAIL_COUNT_THRESH=25;const FIND_USERNAME_INTERVAL_PERIOD=100;var storageGetItemFailCount=0;var currentUser={'username':'','token':''};var loggedInFlag=!1;var findUsernameInterval=0;var insideImpostorModalFlag=!1;getKeystrokeCodeCollectLimit();findUsername(!0);window.addEventListener('beforeunload',function(event){if(insideImpostorModalFlag){console.log('User tries to escape');sessionStorage.clear()}else{if(keystroke_dt.length>0&&loggedInFlag){if(keystroke_code[keystroke_code.length-1].length<2)keystroke_code.pop()
sendData();keystroke_code=[[]];keystroke_dt=[];t1=-1;console.log('Unload: Data Sent');event.preventDefault()}}});window.addEventListener('click',function(event){if(event.target&&event.target.id=='logginButtonID'){console.log('login clicked');if(findUsernameInterval==0){findUsernameInterval=setInterval(findUsername,FIND_USERNAME_INTERVAL_PERIOD)}}
else if(event.target&&event.target.id=='logoutHrefID'){console.log('logout clicked');if(keystroke_code.length>0&&keystroke_code[0].length>1){if(keystroke_code[keystroke_code.length-1].length<2){keystroke_code.pop()}
sendData()}
resetLogInStuff();resetKeystrokeData();resetT1()}});var keystrokeSubscriber=keydownDOMObserver.subscribe(function(keyEvent){onKeyDownProcedure(keyEvent)},function(err){console.log('Error in keydown event: '+err)});function getKeystrokeCodeCollectLimit(){Rx.DOM.get({url:cont_auth_server_get_keystroke_code_limit,headers:myheaders}).subscribe(function(data){res=JSON.parse(data.response);if(res.success==!0){KEYSTROKE_CODE_COLLECT_LIMIT=Number(res.keystroke_code_collect_limit);KEYSTROKE_CODE_COLLECT_LIMIT_BACKUP=Number(res.keystroke_code_collect_limit);console.log('Keystroke Code Limit Loaded to: -> '+String(KEYSTROKE_CODE_COLLECT_LIMIT))}else{console.log('Problem with collect keystroke code limit');KEYSTROKE_CODE_COLLECT_LIMIT=20;KEYSTROKE_CODE_COLLECT_LIMIT_BACKUP=20;console.log(res)}},function(error){KEYSTROKE_CODE_COLLECT_LIMIT=20;KEYSTROKE_CODE_COLLECT_LIMIT_BACKUP=20;console.log('Error at get keystroke code collect limit');console.log(error)})}
function onKeyDownProcedure(e){if(loggedInFlag){logKeystrokeData(e)}else{if(e.target.classList.contains('keystroke-auth-box-user-feedback')){logKeystrokeData(e,!1)}}}
function logKeystrokeData(e,sendAfterCodeLengthLimitFlag=!0){t2=Date.now();let keyCode;if(e.keyCode>=65&&e.keyCode<=90){keyCode=e.keyCode}else if(e.key>='1'&&e.key<='9'){keyCode=64}else{return}
if(t1!=-1){keystroke_dt.push(Math.round(t2-t1));keystroke_code[keystroke_code.length-1].push(keyCode);if(keystroke_code.length>=KEYSTROKE_CODE_COLLECT_LIMIT&&sendAfterCodeLengthLimitFlag){sendData();keystroke_code=[[keyCode]];keystroke_dt=[]}else{keystroke_code.push([keyCode])}}else{keystroke_code[0].push(keyCode)}
t1=t2}
function sendData(){let dataBody={track_code:track_code,subject:currentUser.username,keystroke_code:JSON.stringify(keystroke_code),keystroke_dt:JSON.stringify(keystroke_dt)};Rx.DOM.post({url:cont_auth_server_collect_url,body:dataBody,headers:myheaders}).subscribe(function(data){res=JSON.parse(data.response);if(res.alert==!0&&loggedInFlag){if(res.isImpostor==!0){console.log('Server: User is impostor!');if(!insideImpostorModalFlag){activateImpostorModal()}else{deactivateImpostorModal();activateUserRejectedModal();setTimeout(function(){window.location.replace(window.location.origin+'/login')},4500)}}else{if(res.not_enough_training==!0){alert('Impostor Alert Failed: Not enough training to test the data!!!')}}}else{if(!insideImpostorModalFlag){}else{deactivateImpostorModal();insideImpostorModalFlag=!1;activateUserRetakeSuccessModal();resetKeystrokeData();resetT1();KEYSTROKE_CODE_COLLECT_LIMIT=KEYSTROKE_CODE_COLLECT_LIMIT_BACKUP}}},function(err){console.log('Error at ajax POST: ');console.log(err)})}
function findUsername(justOnce=!1){console.log('Searching username');let tmp_currentUser=sessionStorage.getItem('currentUser');if(tmp_currentUser==null){if(justOnce){console.log('Username not found');return}
storageGetItemFailCount++;if(storageGetItemFailCount>=STORAGE_GET_ITEM_FAIL_COUNT_THRESH){console.log('find username failed');if(findUsernameInterval!==0){clearInterval(findUsernameInterval);findUsernameInterval=0;storageGetItemFailCount=0;return}}}else{try{tmp_currentUser=JSON.parse(tmp_currentUser);try{console.log('Trying to decode token');let decode_tok=jwt_decode(tmp_currentUser.token);let tmp_username=decode_tok.username;if(tmp_username===undefined){console.log('No username in this jwt-token')}else{console.log('Username found ->');console.log(tmp_currentUser.username);currentUser.token=tmp_currentUser.token;currentUser.username=tmp_username;loggedInFlag=!0;if(findUsernameInterval!==0){clearInterval(findUsernameInterval);findUsernameInterval=0}
if(keystroke_code[keystroke_code.length-1].length!=2){keystroke_code.pop()}
sendData();resetKeystrokeData();resetT1()}}catch(err){console.log('Invalid jwt-token');console.log(err);storageGetItemFailCount++}}catch(error){console.log('Error in JSON.parse of currentUser');console.log(error)}}}
function activateImpostorModal(){console.log('Inside activate Impostor Modal...');insideImpostorModalFlag=!0;if(!document.getElementById('keyguardScriptImpostorModal')){$(document.body).append('\
        <div class="modal" id="keyguardScriptImpostorModal">\
          <div class="modal-dialog">\
            <div class="modal-content">\
              <div class="modal-header" style="text-align:center;">\
                 <i class="fa fa-hand-paper-o fa-4x" style="color:red;" aria-hidden="true"></i>\
                <h3 class="modal-title" style="font-weight:bold;">&nbsp;Keystroke Authentication Failed!</h3>\
              </div>\
              <div class="modal-body">\
                 <p style="text-align:center;margin-top:-10px;font-size:14px;">You are requested to <strong>type the text below</strong> , in order to continue browsing this website.</p>\
                <br>\
                <div class="retake-access-container" style="border-radius:7px;background-color:rgba(0, 0, 0,0.84);padding:25px 8px 30px 8px;">\
                  <div class="retake-p-input" style="text-align:center;">\
                     <p id="keyguardScriptretakeP" style="font-size:20px;color:white;"><img src="data:image/gif;base64,R0lGODlhEAAQAPIAAP///wAAAMLCwkJCQgAAAGJiYoKCgpKSkiH/C05FVFNDQVBFMi4wAwEAAAAh/hpDcmVhdGVkIHdpdGggYWpheGxvYWQuaW5mbwAh+QQJCgAAACwAAAAAEAAQAAADMwi63P4wyklrE2MIOggZnAdOmGYJRbExwroUmcG2LmDEwnHQLVsYOd2mBzkYDAdKa+dIAAAh+QQJCgAAACwAAAAAEAAQAAADNAi63P5OjCEgG4QMu7DmikRxQlFUYDEZIGBMRVsaqHwctXXf7WEYB4Ag1xjihkMZsiUkKhIAIfkECQoAAAAsAAAAABAAEAAAAzYIujIjK8pByJDMlFYvBoVjHA70GU7xSUJhmKtwHPAKzLO9HMaoKwJZ7Rf8AYPDDzKpZBqfvwQAIfkECQoAAAAsAAAAABAAEAAAAzMIumIlK8oyhpHsnFZfhYumCYUhDAQxRIdhHBGqRoKw0R8DYlJd8z0fMDgsGo/IpHI5TAAAIfkECQoAAAAsAAAAABAAEAAAAzIIunInK0rnZBTwGPNMgQwmdsNgXGJUlIWEuR5oWUIpz8pAEAMe6TwfwyYsGo/IpFKSAAAh+QQJCgAAACwAAAAAEAAQAAADMwi6IMKQORfjdOe82p4wGccc4CEuQradylesojEMBgsUc2G7sDX3lQGBMLAJibufbSlKAAAh+QQJCgAAACwAAAAAEAAQAAADMgi63P7wCRHZnFVdmgHu2nFwlWCI3WGc3TSWhUFGxTAUkGCbtgENBMJAEJsxgMLWzpEAACH5BAkKAAAALAAAAAAQABAAAAMyCLrc/jDKSatlQtScKdceCAjDII7HcQ4EMTCpyrCuUBjCYRgHVtqlAiB1YhiCnlsRkAAAOwAAAAAAAAAAAA=="></p>\
                  </div>\
                  <div class="retake-input" style="text-align:center;">\
                     <input id="keyguardScriptretakeInput" ondrop="return false" onpaste="return false" placeholder="start typing..." style="width:90%;color:black;font-size:20px;">\
                  </div>\
                </div>\
             </div>\
            </div>\
          </div>\
        </div>')
$("#keyguardScriptretakeInput").on("click",function(){$('#keyguardScriptretakeInput').css({"background-image":"url(\'http://loadinggif.com/images/image-selection/3.gif\')","background-size":"25px 25px","background-position":"right center","background-repeat":"no-repeat",})})}else{$('#keyguardScriptretakeP').html('<img src="data:image/gif;base64,R0lGODlhEAAQAPIAAP///wAAAMLCwkJCQgAAAGJiYoKCgpKSkiH/C05FVFNDQVBFMi4wAwEAAAAh/hpDcmVhdGVkIHdpdGggYWpheGxvYWQuaW5mbwAh+QQJCgAAACwAAAAAEAAQAAADMwi63P4wyklrE2MIOggZnAdOmGYJRbExwroUmcG2LmDEwnHQLVsYOd2mBzkYDAdKa+dIAAAh+QQJCgAAACwAAAAAEAAQAAADNAi63P5OjCEgG4QMu7DmikRxQlFUYDEZIGBMRVsaqHwctXXf7WEYB4Ag1xjihkMZsiUkKhIAIfkECQoAAAAsAAAAABAAEAAAAzYIujIjK8pByJDMlFYvBoVjHA70GU7xSUJhmKtwHPAKzLO9HMaoKwJZ7Rf8AYPDDzKpZBqfvwQAIfkECQoAAAAsAAAAABAAEAAAAzMIumIlK8oyhpHsnFZfhYumCYUhDAQxRIdhHBGqRoKw0R8DYlJd8z0fMDgsGo/IpHI5TAAAIfkECQoAAAAsAAAAABAAEAAAAzIIunInK0rnZBTwGPNMgQwmdsNgXGJUlIWEuR5oWUIpz8pAEAMe6TwfwyYsGo/IpFKSAAAh+QQJCgAAACwAAAAAEAAQAAADMwi6IMKQORfjdOe82p4wGccc4CEuQradylesojEMBgsUc2G7sDX3lQGBMLAJibufbSlKAAAh+QQJCgAAACwAAAAAEAAQAAADMgi63P7wCRHZnFVdmgHu2nFwlWCI3WGc3TSWhUFGxTAUkGCbtgENBMJAEJsxgMLWzpEAACH5BAkKAAAALAAAAAAQABAAAAMyCLrc/jDKSatlQtScKdceCAjDII7HcQ4EMTCpyrCuUBjCYRgHVtqlAiB1YhiCnlsRkAAAOwAAAAAAAAAAAA==">');$('#keyguardScriptretakeInput').css({"background-image":"","background-size":"","background-position":"","background-repeat":"",})}
$('#keyguardScriptretakeInput').val('');$("#ngx-app-container-wrapper").css("opacity","0");$('#keyguardScriptImpostorModal').modal({backdrop:'static',keyboard:!1})
var randomSentence='...';Rx.DOM.get({url:cont_auth_server_get_random_sentence+'/'+String(RANDOM_SENTENCE_RETAKE_MAXIMUM_LENGTH),headers:myheaders}).subscribe(function(data){res=JSON.parse(data.response);if(res.success==!0){randomSentence=res.sentence;$('#keyguardScriptretakeP').text(randomSentence);resetKeystrokeData();resetT1();KEYSTROKE_CODE_COLLECT_LIMIT=(randomSentence.length)-(randomSentence.split(' ').length-1)-KEYSTROKE_CODE_COLLECT_LIMIT_RETAKE_OFFSET}},function(error){console.log(error);randomSentence='hello world'
$('#keyguardScriptretakeP').text(randomSentence);resetKeystrokeData();resetT1();KEYSTROKE_CODE_COLLECT_LIMIT=(randomSentence.length)-(randomSentence.split(' ').length-1)-KEYSTROKE_CODE_COLLECT_LIMIT_RETAKE_OFFSET})}
function deactivateImpostorModal(){$('#keyguardScriptImpostorModal').modal('hide');$("#ngx-app-container-wrapper").css("opacity","1")}
function activateUserRejectedModal(){$(document.body).append('\
    <div class="modal" id="keyguardScriptUserRejectedModal">\
      <div class="modal-dialog">\
        <div class="modal-content">\
          <div class="modal-header" style="text-align:center;">\
            <i class="fa fa-ban fa-4x" style="color:red;" aria-hidden="true"></i>\
            <h2 class="modal-title" style="font-weight:bold;">&nbsp;You are rejected!</h2>\
            <p style="font-style:italic;">You will be redirected back to login page.</p>\
          </div>\
        </div>\
      </div>\
    </div>')
$("#ngx-app-container-wrapper").css("opacity","0");$('#keyguardScriptUserRejectedModal').modal({backdrop:'static',keyboard:!1})}
function deactivateUserRejectedModal(){$('#keyguardScriptUserRejectedModal').modal('hide');$("#ngx-app-container-wrapper").css("opacity","1")}
function activateUserRetakeSuccessModal(){if(!document.getElementById('keyguardScriptUserRetakeSuccessModal')){$(document.body).append('\
        <div class="modal" id="keyguardScriptUserRetakeSuccessModal">\
          <div class="modal-dialog">\
            <div class="modal-content">\
              <div class="modal-header" style="text-align:center;">\
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>\
                 <i class="fa fa-check-circle fa-4x" aria-hidden="true" style="color:green;"></i>\
                <h2 class="modal-title" style="font-weight:bold;">You passed the test!</h2>\
              <p style="font-style:italic;">You can continue browsing this website.</p>\
                <div align="right"><button type="button" class="btn btn-default"  data-dismiss="modal">Close</button></div>\
              </div>\
            </div>\
          </div>\
        </div>')}
$("#ngx-app-container-wrapper").css("opacity","1");$('#keyguardScriptUserRetakeSuccessModal').modal('show')}
function stripHtmlFromString(htmlStr){var html=htmlStr;var div=document.createElement("div");div.innerHTML=html;return div.textContent||div.innerText||""}
function stripNonLettersAndNonNumbersFromString(str){var ret='';for(let i=0;i<str.length;i++){if((str[i].toLowerCase()>='a'&&str[i].toLowerCase()<='z')||(str[i]>='0'&&str[i]<='9')||str[i]==' '){ret+=str[i]}}
return ret}
function restrictStringLength(str,maxStrSize){if(str.length>maxStrSize){var temp=str;if(temp[maxStrSize]!==' '){var offset=temp.substring(maxStrSize).indexOf(' ');if(offset>-1){maxStrSize+=offset}else{maxStrSize=str.length}}}
return str.substr(0,maxStrSize)}
function resetKeystrokeData(){keystroke_code=[[]];keystroke_dt=[]}
function resetT1(){t1=-1}
function resetLogInStuff(){currentUser.token='';currentUser.username='';loggedInFlag=!1}
